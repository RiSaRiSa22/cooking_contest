---
phase: 02-admin-dishes
plan: "03"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - supabase/functions/competition-settings/index.ts
  - src/components/competition/ParticipantCard.tsx
  - src/screens/Admin/tabs/ParticipantsTab.tsx
  - src/screens/Admin/tabs/RankingTab.tsx
  - src/screens/Admin/tabs/SettingsTab.tsx
  - src/screens/Admin/AdminScreen.tsx
autonomous: false

must_haves:
  truths:
    - "ParticipantsTab shows all participants with nickname, role badge, dish status, and vote status"
    - "RankingTab shows dishes ranked by vote count with admin toggle to reveal chef names"
    - "SettingsTab shows competition code, phase, participant/dish/vote counts, and phase advance button"
    - "Admin can advance phase preparation -> voting -> finished with confirmation"
    - "Admin can reset all votes with confirmation"
    - "Phase transitions are unidirectional and enforced server-side"
  artifacts:
    - path: "supabase/functions/competition-settings/index.ts"
      provides: "Edge Function for phase transitions and vote reset"
      contains: "advance_phase"
    - path: "src/components/competition/ParticipantCard.tsx"
      provides: "Participant card with avatar, nickname, status badges"
      exports: ["ParticipantCard"]
    - path: "src/screens/Admin/tabs/ParticipantsTab.tsx"
      provides: "Participants list tab"
      exports: ["ParticipantsTab"]
    - path: "src/screens/Admin/tabs/RankingTab.tsx"
      provides: "Admin ranking tab with chef reveal toggle"
      exports: ["RankingTab"]
    - path: "src/screens/Admin/tabs/SettingsTab.tsx"
      provides: "Settings tab with phase control and stats"
      exports: ["SettingsTab"]
  key_links:
    - from: "src/screens/Admin/tabs/SettingsTab.tsx"
      to: "supabase/functions/competition-settings"
      via: "supabase.functions.invoke('competition-settings', ...)"
      pattern: "invoke.*competition-settings"
    - from: "src/screens/Admin/tabs/ParticipantsTab.tsx"
      to: "src/store/competitionStore.ts"
      via: "reads participants and dishes from store"
      pattern: "useCompetitionStore"
    - from: "src/screens/Admin/tabs/RankingTab.tsx"
      to: "src/store/competitionStore.ts"
      via: "reads dishes and computes vote counts"
      pattern: "useCompetitionStore"
---

<objective>
Build the remaining 3 admin tabs (Partecipanti, Classifica, Impostazioni) plus the competition-settings Edge Function for phase transitions and vote reset. Also wire ParticipantCard component.

Purpose: Completes the admin panel with all 4 tabs operational. The admin gains full control: manage participants, view ranking, advance phase, and reset votes.
Output: All 4 admin tabs functional. Phase transitions and vote reset work end-to-end via Edge Function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-dishes/02-RESEARCH.md
@.planning/phases/02-admin-dishes/02-01-SUMMARY.md

Key existing files to reference:
@supabase/functions/competition-create/index.ts (Edge Function pattern)
@src/store/competitionStore.ts (created in 02-01)
@src/hooks/useCompetition.ts (created in 02-01, Realtime subscription)
@src/screens/Admin/AdminScreen.tsx (created in 02-01, tab shell)
@src/screens/Admin/modals/ConfirmModal.tsx (created in 02-02, reuse for phase/reset confirms)
@src/components/ui/index.ts (Button, Input, Modal, Toast)
@src/types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: competition-settings Edge Function + SettingsTab</name>
  <files>
    supabase/functions/competition-settings/index.ts
    src/screens/Admin/tabs/SettingsTab.tsx
  </files>
  <action>
    **1. Create `supabase/functions/competition-settings/index.ts`**
    Follow the established Edge Function pattern (Deno, npm: imports, CORS, service_role).

    Zod schema using discriminated union:
    ```typescript
    const SettingsSchema = z.discriminatedUnion('action', [
      z.object({
        action: z.literal('advance_phase'),
        competitionId: z.string().uuid(),
        participantId: z.string().uuid(),
      }),
      z.object({
        action: z.literal('reset_votes'),
        competitionId: z.string().uuid(),
        participantId: z.string().uuid(),
      }),
    ])
    ```

    Authorization: Both actions require participant.role === 'admin'. Verify via DB lookup.

    **advance_phase logic (COMP-01, COMP-02):**
    1. Fetch current competition phase
    2. Compute next phase: `preparation` -> `voting` -> `finished`
    3. If current phase === 'finished': return 400 "Gara gia conclusa"
    4. UPDATE competitions SET phase = nextPhase WHERE id = competitionId
    5. Return `{ phase: nextPhase }` with 200

    **reset_votes logic (COMP-03):**
    1. DELETE FROM votes WHERE competition_id = competitionId
    2. Return `{ success: true, deletedCount: N }` with 200

    Deploy via supabase-local MCP with verify_jwt: false.

    **2. Create `src/screens/Admin/tabs/SettingsTab.tsx`**
    Read competition, dishes, participants from competitionStore.
    Get session from sessionStore for participantId.

    Layout sections:

    **Section 1 â€” Codice gara:**
    - Display competition code in large font-display with copy button
    - "Condividi link" button that copies the join URL (`${window.location.origin}${window.location.pathname}#/?code=CODE&mode=join`) to clipboard with Toast confirmation
    - QR code image via external API: `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(joinUrl)}&size=200x200`
    - Display QR as `<img>` tag (no npm package needed)

    **Section 2 â€” Statistiche:**
    - Card grid showing: Partecipanti count, Piatti count, Voti count (from store data, votes need fetch â€” for now show dishes.length, participants.length; votes count can be fetched or shown as "â€”" until Phase 3)
    - Use emoji + number + label pattern

    **Section 3 â€” Fase gara:**
    - Current phase displayed with PhaseBanner-style badge
    - "Avanza fase" button (ember variant):
      - In `preparation`: button text "Avvia votazione ðŸ—³ï¸"
      - In `voting`: button text "Concludi gara ðŸ†"
      - In `finished`: button disabled, text "Gara conclusa"
    - On click: open ConfirmModal (from 02-02) with appropriate message:
      - preparation->voting: "Vuoi avviare la votazione? I partecipanti non potranno piÃ¹ modificare i piatti."
      - voting->finished: "Vuoi concludere la gara? La classifica finale sarÃ  visibile a tutti."
    - On confirm: call `supabase.functions.invoke('competition-settings', { body: { action: 'advance_phase', ... } })`
    - On success: optimistically update store via `updatePhase(newPhase)`, show Toast

    **Section 4 â€” Azioni pericolose:**
    - "Reset voti" button (ghost variant, red text), only visible if phase !== 'preparation'
    - On click: ConfirmModal with message "Vuoi eliminare tutti i voti? L'azione e irreversibile."
    - On confirm: call competition-settings with action 'reset_votes'
    - On success: show Toast with deleted count

    Styling: sections separated by dividers, padding px-4 py-6, card backgrounds white/rounded-xl.
  </action>
  <verify>
    `npx tsc --noEmit` passes. competition-settings Edge Function file exists. SettingsTab renders all 4 sections. Phase advance button text changes based on current phase.
  </verify>
  <done>
    competition-settings EF handles phase transitions (unidirectional) and vote reset (admin-only). SettingsTab shows code+QR, stats, phase control with confirmation, and reset votes with confirmation. Realtime updates phase across tabs.
  </done>
</task>

<task type="auto">
  <name>Task 2: ParticipantCard + ParticipantsTab + RankingTab + AdminScreen wiring</name>
  <files>
    src/components/competition/ParticipantCard.tsx
    src/screens/Admin/tabs/ParticipantsTab.tsx
    src/screens/Admin/tabs/RankingTab.tsx
    src/screens/Admin/AdminScreen.tsx
  </files>
  <action>
    **1. Create `src/components/competition/ParticipantCard.tsx`**
    Props: `{ participant: Participant, dish?: DishWithPhotos | null, voteCount?: number }`
    - Horizontal card (flex-row): avatar circle (first letter of nickname, colored background), info section, status badges
    - Avatar: 40x40 rounded-full with initials, background color derived from nickname hash (cycle through predefined palette: ember, gold, sage, sky, plum)
    - Info: nickname (font-semibold), role badge if admin ("ðŸ‘‘ Admin" in gold), join time relative
    - Status badges (right side):
      - Dish status: "ðŸ½ï¸" green check if participant has a dish, gray "â€”" if not
      - Vote status: "ðŸ—³ï¸" green check if participant voted, gray "â€”" if not (vote data available in Phase 3 â€” for now show "â€”")
    - Card styling: bg-white, rounded-xl, p-3, shadow-sm

    **2. Create `src/screens/Admin/tabs/ParticipantsTab.tsx`**
    Read participants and dishes from competitionStore.
    - Map each participant to its dish (if any): find dish where dish.participant_id === participant.id
    - Render list of ParticipantCard components
    - Sort: admin first, then by join time
    - Header: "Partecipanti ({count})" with count badge
    - Empty state: "Nessun partecipante ancora" (shouldn't happen â€” admin is always a participant)

    **3. Create `src/screens/Admin/tabs/RankingTab.tsx`**
    Read dishes and competition from competitionStore.
    - Admin-only ranking view (ADMN-03): shows dishes ranked by vote count
    - Since votes table has no anon SELECT policy, admin cannot read votes directly from SDK. For Phase 2, show dishes sorted by name with a note "Classifica disponibile dopo le votazioni"
    - If phase === 'finished' OR phase === 'voting':
      - Display dishes in order (placeholder: alphabetical by name, actual vote-based ranking deferred to Phase 3 when vote-cast EF exists)
      - Each item: medal emoji for top 3 (ðŸ¥‡ðŸ¥ˆðŸ¥‰), dish name, vote count (shown as "â€” voti" until Phase 3 provides actual data)
    - Toggle "Rivela cuochi" (useState boolean, default false):
      - When ON: show chef_name next to each dish
      - When OFF: show "???"
      - Toggle uses a simple switch/checkbox
      - Admin always has access to chef_name from competitionStore (reads `dishes` table, not `dishes_public`)
    - If phase === 'preparation': show message "La classifica sara disponibile durante la votazione"

    **4. Update `src/screens/Admin/AdminScreen.tsx`**
    Replace the 3 remaining placeholder divs with actual tab component imports:
    - `activeTab === 'partecipanti'` -> `<ParticipantsTab />`
    - `activeTab === 'classifica'` -> `<RankingTab />`
    - `activeTab === 'impostazioni'` -> `<SettingsTab />`
    Import all 3 tab components. DishesTab was already wired in 02-02.
  </action>
  <verify>
    `npm run build` passes. All 4 tabs render real content in AdminScreen. ParticipantCard shows avatar + nickname + badges. RankingTab has chef reveal toggle.
  </verify>
  <done>
    ParticipantsTab shows all participants with avatars, role badges, and dish status. RankingTab shows dish list with chef reveal toggle (votes deferred to Phase 3). AdminScreen has all 4 tabs wired with real components.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>All 4 admin tabs (Piatti, Partecipanti, Classifica, Impostazioni) fully wired. competition-settings Edge Function for phase transitions and vote reset. ParticipantCard component. QR code in Settings tab.</what-built>
  <how-to-verify>
    1. Open admin panel for an existing competition
    2. Tab "Piatti": verify dishes show (from 02-02); CRUD works
    3. Tab "Partecipanti": verify participant list shows admin with crown badge and at least 1 entry
    4. Tab "Classifica": verify dishes listed; toggle "Rivela cuochi" shows/hides chef names
    5. Tab "Impostazioni":
       a. Competition code visible with copy button â€” copy and verify clipboard
       b. QR code image renders
       c. Stats show participant and dish counts
       d. Click "Avvia votazione" â€” ConfirmModal appears
       e. Confirm â€” phase changes to "voting", PhaseBanner updates
       f. Click "Concludi gara" â€” confirm â€” phase changes to "finished"
       g. PhaseBanner now shows "Gara conclusa"
    6. Verify phase changes are reflected across all tabs
    7. Check browser console: no errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. competition-settings EF enforces admin-only + unidirectional phase transitions
4. All 4 admin tabs render with real data from competitionStore
5. Phase advance works: preparation -> voting -> finished
6. Vote reset works (admin only, with confirmation)
7. Chef reveal toggle works in RankingTab
8. QR code renders in SettingsTab
9. ParticipantCard shows avatar, nickname, role badge
</verification>

<success_criteria>
- AdminScreen has 4 fully operational tabs
- Admin can advance phase with confirmation (unidirectional)
- Admin can reset votes with confirmation
- ParticipantsTab lists all participants with dish status
- RankingTab shows dishes with chef reveal toggle
- SettingsTab shows code, QR, stats, phase control, and dangerous actions
- Phase transitions are enforced server-side in competition-settings EF
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-dishes/02-03-SUMMARY.md`
</output>
