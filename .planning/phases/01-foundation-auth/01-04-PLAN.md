---
phase: 01-foundation-auth
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - supabase/functions/competition-create/index.ts
  - supabase/functions/competition-join/index.ts
  - src/screens/Home/CreateCompModal.tsx
  - src/screens/Home/JoinCompModal.tsx
  - src/screens/Home/CompCreatedScreen.tsx
  - src/screens/Home/ReAuthModal.tsx
  - src/screens/Home/HomeScreen.tsx
  - src/hooks/useAuth.ts
  - src/router.tsx
autonomous: false

user_setup:
  - service: supabase
    why: "Edge Functions need Supabase project URL and keys"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> URL"
      - name: VITE_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
    dashboard_config:
      - task: "Create Supabase project (if not already created)"
        location: "https://supabase.com/dashboard -> New Project"

must_haves:
  truths:
    - "Admin can create a competition with name + nickname + PIN, receives a 6-char code, and lands on a success screen with the code"
    - "Participant can join with code + nickname + PIN, session is saved, and they are redirected to voter screen"
    - "Existing nickname + correct PIN re-authenticates; wrong PIN shows error"
    - "Providing admin password in PIN field grants admin access"
    - "Re-auth modal appears when clicking a recent competition with expired session; only PIN required (nickname pre-filled)"
    - "Deep link /#/?code=ABC123&mode=join opens join modal with code pre-filled"
    - "Guest voter can enter without adding a dish (same join flow as participant, no separate role — dish addition is always optional; allow_guests flag stored but not enforced as join gate in Phase 1)"
  artifacts:
    - path: "supabase/functions/competition-create/index.ts"
      provides: "Edge Function: validates input, hashes PIN, generates code, creates competition + admin participant"
      exports: ["Deno.serve handler"]
    - path: "supabase/functions/competition-join/index.ts"
      provides: "Edge Function: validates input, handles new user vs re-auth, rate limiting"
      exports: ["Deno.serve handler"]
    - path: "src/screens/Home/CreateCompModal.tsx"
      provides: "Create competition modal with name, nickname, PIN fields"
      exports: ["CreateCompModal"]
    - path: "src/screens/Home/JoinCompModal.tsx"
      provides: "Join competition modal with code, nickname, PIN fields"
      exports: ["JoinCompModal"]
    - path: "src/screens/Home/CompCreatedScreen.tsx"
      provides: "Full-screen success view showing competition code with copy button"
      exports: ["CompCreatedScreen"]
    - path: "src/screens/Home/ReAuthModal.tsx"
      provides: "Re-authentication modal (PIN only, nickname pre-filled)"
      exports: ["ReAuthModal"]
    - path: "src/hooks/useAuth.ts"
      provides: "Hook wrapping competition-create and competition-join Edge Function calls"
      exports: ["useAuth"]
  key_links:
    - from: "src/hooks/useAuth.ts"
      to: "supabase/functions/competition-create/index.ts"
      via: "supabase.functions.invoke('competition-create')"
      pattern: "functions.invoke.*competition-create"
    - from: "src/hooks/useAuth.ts"
      to: "supabase/functions/competition-join/index.ts"
      via: "supabase.functions.invoke('competition-join')"
      pattern: "functions.invoke.*competition-join"
    - from: "src/hooks/useAuth.ts"
      to: "src/store/sessionStore.ts"
      via: "addSession after successful auth"
      pattern: "addSession"
    - from: "src/screens/Home/HomeScreen.tsx"
      to: "src/screens/Home/CreateCompModal.tsx"
      via: "state toggle on CTA click"
      pattern: "CreateCompModal"
    - from: "src/router.tsx"
      to: "deep link query params"
      via: "useSearchParams parsing code and mode"
      pattern: "useSearchParams"
---

<objective>
Implement the complete authentication flow: Edge Functions for competition creation and joining, frontend modals for create/join/re-auth, deep link handling, and session management.

Purpose: This is the end-to-end auth flow — the core of Phase 1. Without this, no user can create or enter a competition.
Output: Two deployed Edge Functions, four modal/screen components, a useAuth hook, and working deep link support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md — Pattern 6 (Edge Function auth), Pattern 8 (rate limiting)
@.planning/phases/01-foundation-auth/01-CONTEXT.md — Decisions on create flow, join flow, re-auth
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md — schema details, table structure
@.planning/phases/01-foundation-auth/01-03-SUMMARY.md — UI components, session store, home screen
@FEATURES.md — Section 3 (Authentication and Sessions), Section 7 (Sharing Links)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Edge Functions — competition-create and competition-join</name>
  <files>
    supabase/functions/competition-create/index.ts
    supabase/functions/competition-join/index.ts
  </files>
  <action>
    **competition-create/index.ts:**

    Edge Function that creates a new competition. Uses service_role key (Deno env, never exposed to client).

    Request body (validate with Zod — use `import { z } from 'npm:zod'`, check v4 compatibility):
    ```
    { name: string (min 1), nickname: string (min 1), pinHash: string, allowGuests?: boolean, maxParticipants?: number }
    ```

    Logic:
    1. Validate input with Zod schema
    2. Generate unique 6-char code: uppercase alphanumeric, check uniqueness against competitions table (retry loop, max 5 attempts)
    3. Insert into `competitions`: name, code, admin_pwd_hash = pinHash (admin's PIN serves as password per CONTEXT.md), phase = 'preparation', allow_guests, max_participants
    4. Insert into `participants`: competition_id, nickname, pin_hash = pinHash, role = 'admin'
    5. Return: `{ code, competitionId, participantId, nickname, role: 'admin' }`

    CORS headers: Allow `*` origin (or the specific GH Pages domain). Add preflight OPTIONS handler.

    Error responses: 400 for validation errors, 500 for DB errors. JSON format: `{ error: string }`.

    **competition-join/index.ts:**

    Edge Function for joining a competition (new user or re-auth).

    Request body:
    ```
    { code: string, nickname: string, pinHash: string }
    ```

    Logic:
    1. Validate input with Zod
    2. Look up competition by code — 404 if not found
    3. **Rate limiting** (RESEARCH.md Pattern 8): Count login_attempts for this code+nickname in last 15 min. If >= 5, return 429.
    4. Log attempt in login_attempts table
    5. Check if participant with this nickname exists in this competition:

    **Case A: New participant**
    - Check `competition.allow_guests`: if `false`, all joiners become regular participants (no guest distinction in Phase 1). If `true`, joiners still become `role = 'participant'` — the guest concept is implicit: any participant who never adds a dish is effectively a guest voter. There is no separate 'guest' role in the DB. SC-3 (guest voter) is satisfied because adding a dish is always optional — the join flow never requires it. This is a Phase 1 design decision: `allow_guests` flag is stored but not enforced as a gate in the join flow. It will be used in Phase 2+ to control UI prompts (e.g., skip "add your dish" nudge for guest-allowed competitions).
    - Check if nickname is already taken → 409 "Soprannome gia in uso" with suggestion (append random 2-digit number)
    - Check `competition.max_participants`: if set and current participant count >= max, return 403 "Gara al completo"
    - Insert into participants: competition_id, nickname, pin_hash = pinHash, role = 'participant'
    - Return: `{ competitionId, participantId, nickname, role: 'participant', competitionName }`

    **Case B: Existing participant (re-auth)**
    - Compare pinHash with stored pin_hash — if match, return session data
    - If no match, check against competition's admin_pwd_hash — if match, the user is the admin (AUTH-06)
    - If neither match → 401 "PIN errato"
    - Return: `{ competitionId, participantId, nickname, role, competitionName }`

    **Note on AUTH-06:** When a user provides the admin password in the PIN field, the system detects it by comparing the hash against `admin_pwd_hash`. The join endpoint finds the admin participant record (role='admin') for that competition and returns the admin session.

    CORS headers same as competition-create.

    Deploy both Edge Functions using supabase-local MCP `deploy_edge_function` tool. Set `verify_jwt: false` for both (no Supabase Auth JWT — custom auth).
  </action>
  <verify>
    Deploy and test with curl or via supabase-local MCP:

    1. Create competition:
    ```bash
    curl -X POST http://localhost:54321/functions/v1/competition-create \
      -H "Content-Type: application/json" \
      -d '{"name":"Test Gara","nickname":"Mario","pinHash":"abc123"}'
    ```
    Expect: 200 with code (6 chars), competitionId (uuid), role: "admin"

    2. Join as new participant:
    ```bash
    curl -X POST http://localhost:54321/functions/v1/competition-join \
      -H "Content-Type: application/json" \
      -d '{"code":"<CODE>","nickname":"Luigi","pinHash":"def456"}'
    ```
    Expect: 200 with role: "participant"

    3. Re-auth with correct PIN: same nickname + same pinHash → 200
    4. Re-auth with wrong PIN: → 401
    5. Join with duplicate nickname (different PIN): → 409
    6. Rate limiting: 6 rapid failed attempts → 429 on 6th
  </verify>
  <done>
    Both Edge Functions deployed and handle: create competition with unique code, join as new participant, re-authenticate existing participant, admin access via password in PIN field, rate limiting on PIN attempts, nickname conflict detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend auth modals, deep links, and navigation wiring</name>
  <files>
    src/screens/Home/CreateCompModal.tsx
    src/screens/Home/JoinCompModal.tsx
    src/screens/Home/CompCreatedScreen.tsx
    src/screens/Home/ReAuthModal.tsx
    src/screens/Home/HomeScreen.tsx
    src/hooks/useAuth.ts
    src/router.tsx
  </files>
  <action>
    **src/hooks/useAuth.ts** — Hook that wraps Edge Function calls and session management:
    - `createCompetition(data)`: calls competition-create, on success calls `sessionStore.addSession(...)`, returns session
    - `joinCompetition(data)`: calls competition-join, on success calls `sessionStore.addSession(...)`, returns session
    - `reAuthenticate(code, pinHash)`: calls competition-join with stored nickname from sessionStore, refreshes authenticatedAt
    - Each function: loading state, error state, typed return value
    - Uses `supabase.functions.invoke(...)` from `src/lib/supabase.ts`
    - On success, navigates to appropriate screen (admin or voter) using react-router `useNavigate`

    **src/screens/Home/CreateCompModal.tsx** — Modal (bottom-sheet variant) with form:
    - Fields: competition name (Input), nickname (Input), PIN (PinInput)
    - Optional: allow guests toggle (checkbox), max participants (number input)
    - Submit button (ember): "Crea gara"
    - Loading state: button shows spinner, fields disabled
    - Error state: toast with error message
    - On success: close modal, show CompCreatedScreen

    **src/screens/Home/JoinCompModal.tsx** — Modal (bottom-sheet) with form:
    - Fields: competition code (Input, uppercase, maxlength 6), nickname (Input), PIN (PinInput)
    - If opened via deep link with code pre-filled, code field is read-only
    - Submit button (ember): "Entra in gara"
    - Error handling: wrong PIN → toast "PIN errato", nickname taken → toast with suggestion, rate limited → toast with wait message
    - On success: close modal, navigate to `/voter/:code` or `/admin/:code` based on returned role

    **src/screens/Home/CompCreatedScreen.tsx** — Full-screen success view (not a modal):
    - Dark background matching home screen aesthetic
    - Large competition code displayed prominently (font-display, big text, gold color)
    - "Codice copiato!" toast on copy button click
    - Copy to clipboard button (use `navigator.clipboard.writeText`)
    - CTA: "Vai al pannello admin" → navigate to `/admin/:code`
    - CTA secondary: "Torna alla home" → navigate to `/`

    **src/screens/Home/ReAuthModal.tsx** — Modal (center variant) for re-authentication:
    - Shows stored nickname (from sessionStore, read-only label)
    - PIN input only (PinInput component)
    - Calls `useAuth.reAuthenticate` with stored code + nickname
    - On success: navigate to admin/voter screen based on role
    - On error: toast "PIN errato"
    - Close button: returns to home

    **Wire into HomeScreen.tsx:**
    - "Crea nuova gara" button → opens CreateCompModal
    - "Entra con codice" button → opens JoinCompModal
    - Click on recent competition pill → opens ReAuthModal (pass session data)
    - Manage modal state with useState

    **Deep link handling in src/router.tsx:**
    - On the home route `/`, check `useSearchParams` for `code` and `mode` params
    - If `code` param exists and `mode=join`: auto-open JoinCompModal with code pre-filled
    - URL format: `/#/?code=ABC123&mode=join`
    - Implement this as a `useEffect` in `HomeScreen.tsx` that reads `useSearchParams()`: if `code` param exists, set modal state to open `JoinCompModal` with `initialCode={code}`. Clear the search params after reading to avoid re-triggering on navigation. No separate wrapper component needed — HomeScreen owns the modal state already.

    **Route guard:** On `/admin/:code` and `/voter/:code` routes, check session exists and is not expired. If expired or missing, redirect to `/#/?code=:code&mode=join`. This is a basic guard — show loading splash while checking hydration (RESEARCH.md Pitfall 7).
  </action>
  <verify>
    Full end-to-end test flow (requires Supabase running locally with `npx supabase start`):

    1. Open app → home screen renders
    2. Click "Crea nuova gara" → modal opens with fields
    3. Fill: name "Test", nickname "Mario", PIN 1234 → submit
    4. CompCreatedScreen shows with 6-char code → copy button works
    5. Click "Vai al pannello admin" → navigates to /#/admin/CODE (shows placeholder)
    6. Open new incognito tab, go to app
    7. Click "Entra con codice" → fill code, nickname "Luigi", PIN 5678 → submit
    8. Redirects to /#/voter/CODE (shows placeholder)
    9. Close tab, reopen → home shows "Test" in recent competitions
    10. Click on recent competition → ReAuthModal appears with "Luigi" pre-filled
    11. Enter correct PIN → navigates to voter screen
    12. Enter wrong PIN → toast "PIN errato"
    13. Deep link test: navigate to `/#/?code=CODE&mode=join` → JoinCompModal opens with code pre-filled
    14. Wait 2+ hours (or manually set authenticatedAt to past) → session expired, recent comp still shows but clicking triggers full join flow

    TypeScript: `npx tsc --noEmit` — no errors.
  </verify>
  <done>
    Complete auth flow works end-to-end: create competition, join, re-auth, deep link. Sessions persist in localStorage with TTL. Correct routing based on role.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow: create competition, join, re-auth, deep links</what-built>
  <how-to-verify>
    Prerequisites: Supabase running locally (`npx supabase start`), `.env` configured.

    1. Open the app at localhost. Home screen with dark theme, flame animation, buttons.
    2. Click "Crea nuova gara":
       - Fill name: "Gara Test", nickname: "Chef Mario", PIN: 1234
       - Submit → success screen shows 6-char code
       - Copy code to clipboard
       - Navigate to admin panel
    3. Open incognito window, paste the app URL:
       - Click "Entra con codice"
       - Enter the code, nickname "Luigi", PIN 5678
       - Submit → redirects to voter placeholder screen
    4. Close incognito, reopen app:
       - "Gara Test" appears in recent competitions list
       - Click it → re-auth modal shows "Luigi" with PIN boxes
       - Enter 5678 → navigates to voter screen
       - Try wrong PIN → error toast appears
    5. Deep link: open `/#/?code=CODE&mode=join` → join modal opens with code pre-filled
    6. Try entering admin password (1234) as PIN when joining as existing admin nickname → should get admin access
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. competition-create Edge Function: creates competition + admin participant, returns code
2. competition-join Edge Function: handles new user, re-auth, admin-via-password, rate limiting
3. CreateCompModal: validates input, shows loading, handles errors
4. JoinCompModal: validates input, handles all error cases, supports deep link pre-fill
5. CompCreatedScreen: shows code prominently, copy button works
6. ReAuthModal: PIN-only re-auth, uses stored nickname
7. Session persists in localStorage, TTL enforced
8. Deep links parse code and mode correctly
9. Route guards redirect to home if session missing/expired
10. `npm run build` succeeds
</verification>

<success_criteria>
A user can create a competition and receive a shareable code. Another user can join with that code. Both can return later and re-authenticate with just their PIN. Deep links pre-fill the competition code. This satisfies Phase 1 success criteria 1-5 from the roadmap.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-04-SUMMARY.md`
</output>
