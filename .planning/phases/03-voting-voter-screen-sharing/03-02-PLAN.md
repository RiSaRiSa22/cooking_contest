---
phase: 03-voting-voter-screen-sharing
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/dishes/DishDetailSheet.tsx
  - src/screens/Voter/tabs/GalleryTab.tsx
  - src/screens/Voter/tabs/MyDishTab.tsx
autonomous: true

must_haves:
  truths:
    - "Tab Galleria mostra griglia 3 colonne con foto hero di ogni piatto"
    - "Tap su un piatto nella griglia apre un bottom-sheet con dettaglio completo (foto hero, nome, chef label, sezioni espandibili, foto extra)"
    - "Tab Il mio piatto mostra il piatto del partecipante in read-only (modifica in preparation avviene dal pannello admin) con foto extra in voting"
    - "Ospite senza piatto vede empty state in MyDishTab"
    - "Chef label mostra 'Cuoco misterioso' in preparation/voting e nome reale in finished"
  artifacts:
    - path: "src/components/dishes/DishDetailSheet.tsx"
      provides: "Bottom-sheet overlay con dettaglio piatto (foto, info, sezioni espandibili)"
    - path: "src/screens/Voter/tabs/GalleryTab.tsx"
      provides: "Griglia 3 colonne con thumbnails piatti, tap apre DishDetailSheet"
    - path: "src/screens/Voter/tabs/MyDishTab.tsx"
      provides: "Vista del proprio piatto con foto extra in voting, empty state per ospiti"
  key_links:
    - from: "src/screens/Voter/tabs/GalleryTab.tsx"
      to: "src/components/dishes/DishDetailSheet.tsx"
      via: "stato locale selectedDish + render condizionale"
      pattern: "DishDetailSheet"
    - from: "src/screens/Voter/tabs/MyDishTab.tsx"
      to: "src/store/voterStore.ts"
      via: "useVoterStore per myDishId e dishes"
      pattern: "useVoterStore"
    - from: "src/screens/Voter/tabs/MyDishTab.tsx"
      to: "supabase/functions/dish-write"
      via: "supabase.functions.invoke('dish-write') for extra photos in voting"
      pattern: "dish-write"
---

<objective>
Implementare GalleryTab (griglia foto piatti con bottom-sheet dettaglio) e MyDishTab (vista del proprio piatto) per completare la navigazione del VoterScreen.

Purpose: GalleryTab permette ai partecipanti di esplorare tutti i piatti con le foto, e MyDishTab da accesso rapido al proprio piatto (con possibilita di aggiungere foto extra in voting).

Output: DishDetailSheet component riusabile, GalleryTab con griglia e bottom-sheet, MyDishTab con vista piatto e empty state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-voting-voter-screen-sharing/03-RESEARCH.md
@.planning/phases/03-voting-voter-screen-sharing/03-01-SUMMARY.md

# Key existing files
@src/store/voterStore.ts                           # Creato in 03-01 ‚Äî dishes, myDishId, myVotedDishId
@src/screens/Voter/VoterScreen.tsx                 # Shell creata in 03-01
@src/components/dishes/DishCard.tsx                # Pattern UI card piatto (admin)
@src/components/dishes/PhotoGrid.tsx               # Pattern griglia foto
@src/screens/Admin/modals/AddDishModal.tsx          # Pattern bottom-sheet (sheetUp animation)
@src/hooks/usePhotoUpload.ts                       # Per foto extra in MyDishTab
@UI_REFERENCE.md                                    # Sezione 4: Dish Detail Sheet spec
</context>

<tasks>

<task type="auto">
  <name>Task 1: DishDetailSheet + GalleryTab</name>
  <files>src/components/dishes/DishDetailSheet.tsx, src/screens/Voter/tabs/GalleryTab.tsx</files>
  <action>
  **DishDetailSheet.tsx** ‚Äî Bottom-sheet component riusabile (in `components/dishes/` perche potrebbe essere usato anche altrove):

  Props:
  ```typescript
  interface DishDetailSheetProps {
    dish: DishPublicWithPhotos | null   // null = chiuso
    onClose: () => void
    phase: string
    myDishId?: string | null            // per mostrare pulsante vota (opzionale)
    myVotedDishId?: string | null       // per mostrare stato votato (opzionale)
    onVote?: (dishId: string) => void   // callback voto (opzionale, solo da VoteTab futuro o se si vuole votare dalla gallery)
  }
  ```

  Struttura UI (seguire UI_REFERENCE.md sezione 4 ‚Äî Overlays e Modali):
  - **Overlay:** `fixed inset-0 z-50 bg-black/50 flex items-end` con click su overlay ‚Üí chiudi
  - **Sheet:** `bg-white rounded-t-[28px] max-h-[92vh] overflow-y-auto w-full` con animazione `sheetUp` (gia definita in index.css)
  - **Sheet handle:** `mx-auto mt-3 w-10 h-1 rounded-full bg-parchment-deep`
  - **Foto hero:** prima foto del piatto, `w-full max-h-[300px] object-cover`. Se nessuna foto, placeholder con emoji üçΩÔ∏è su sfondo parchment
  - **Pulsante chiudi:** cerchio 34px con X, posizione assoluta top-right sopra la foto
  - **Nome piatto:** font-display text-xl, sotto la foto con px-5
  - **Chef label:**
    - In preparation/voting: "üé≠ Cuoco misterioso" (font-body text-sm, color ink-light)
    - In finished: nome chef reale (dish.chef_name dalla view)
  - **Sezioni espandibili** (ingredienti, ricetta, storia): ognuna con header cliccabile che togga visibilita del contenuto. Usare stato locale `expandedSections: Set<string>`. Mostrare solo sezioni con contenuto non vuoto.
  - **Griglia foto extra:** se ci sono piu di 1 foto, mostrare griglia 3 colonne gap-1 con tutte le foto sotto le sezioni
  - Animazione entrata: usare la classe `animate-sheetUp` (gia in index.css). Animazione uscita: non necessaria per v1, chiusura istantanea.

  **GalleryTab.tsx:**
  - Leggere dishes dal `voterStore`
  - Griglia 3 colonne (`grid grid-cols-3 gap-1 px-1 py-4`) con aspect-ratio quadrato per ogni cella
  - Ogni cella: foto hero (prima foto del piatto) come background-image `object-cover`, o placeholder emoji üçΩÔ∏è se nessuna foto
  - Sotto la foto (overlay in basso): nome piatto in testo bianco con text-shadow su sfondo gradiente semi-trasparente
  - Tap su cella ‚Üí apre DishDetailSheet con il piatto selezionato
  - Stato locale: `selectedDish: DishPublicWithPhotos | null`
  - Empty state: "Nessun piatto in questa gara" se dishes.length === 0
  - Ordinare piatti per nome (localeCompare)
  </action>
  <verify>
  - `npm run build` compila senza errori
  - GalleryTab mostra griglia 3 colonne con foto piatti
  - Tap su cella apre DishDetailSheet con foto hero, nome, chef label, sezioni espandibili
  - Chef label mostra "Cuoco misterioso" in voting, nome reale in finished
  - Chiusura sheet funziona (tap overlay o pulsante X)
  </verify>
  <done>GalleryTab mostra griglia 3 colonne. Tap apre DishDetailSheet con tutti i dettagli del piatto. Chef identity protetta in voting.</done>
</task>

<task type="auto">
  <name>Task 2: MyDishTab</name>
  <files>src/screens/Voter/tabs/MyDishTab.tsx</files>
  <action>
  Implementare MyDishTab che mostra il piatto del partecipante corrente:

  **Logica:**
  - Leggere `myDishId` dal voterStore
  - Trovare il piatto corrispondente in `dishes` (dal voterStore). NOTA: in voting, `dishes_public.participant_id` e null ‚Äî ma `myDishId` viene dalla EF `vote-read` che lo ottiene dalla tabella `dishes` direttamente.
  - Se `myDishId === null` ‚Üí empty state per ospite: "Non hai aggiunto un piatto a questa gara" con emoji üëÄ e suggerimento

  **Se il piatto esiste, mostrare:**
  - Foto hero (prima foto, full-width, rounded-xl, max-h-48, object-cover)
  - Nome piatto (font-display, text-lg, semibold)
  - Nome cuoco (sempre visibile per il PROPRIO piatto ‚Äî ma dishes_public lo nasconde! Soluzione: mostrare il nickname dalla session come chef name, oppure semplicemente non mostrare chef_name e mostrare "Il tuo piatto" come label)
  - Sezioni info (ingredienti, ricetta, storia) se presenti ‚Äî display semplice, non espandibile
  - Griglia foto (tutte le foto del piatto, 3 colonne, gap-2)

  **Foto extra in voting (DISH-06 / VOTR-04):**
  - Se `phase === 'voting'` e il piatto e del partecipante:
    - Mostrare pulsante "+ Aggiungi foto" sotto la griglia foto
    - Al click: usare `usePhotoUpload` hook (gia esistente) per comprimere e uploadare
    - Dopo upload: chiamare `dish-write` EF con `isExtra: true` per aggiornare le foto del piatto
    - Aggiornare il voterStore con le nuove foto
  - Se `phase === 'preparation'`: mostrare nota "Puoi modificare il piatto dal pannello admin" (il partecipante non admin non puo modificare dal VoterScreen in preparation ‚Äî deve usare il flusso admin o il proprio accesso)
  - Se `phase === 'finished'`: vista completamente read-only

  **Note:**
  - Il partecipante NON admin in preparation puo modificare il piatto tramite DishesTab admin ‚Äî VOTR-04 dice "modifica in preparation" ma il VoterScreen non ha il flusso di edit completo (AddDishModal). Per v1, mostrare link testuale "Vai al pannello per modificare" oppure semplicemente la vista read-only. La modifica piatto per non-admin e gia gestita via dish-write EF dalla schermata admin.
  - **Scelta deliberata VOTR-04:** MyDishTab e read-only in tutte le fasi, con l'aggiunta di "foto extra" in voting. La "modifica in preparation" di VOTR-04 e coperta dal pannello admin (DishesTab + AddDishModal) dove il partecipante puo gia modificare il proprio piatto. Non duplicare il flusso edit completo nel VoterScreen per v1.
  </action>
  <verify>
  - `npm run build` compila senza errori
  - Partecipante con piatto: vede foto, nome, info del proprio piatto
  - Ospite senza piatto: vede empty state
  - In voting: pulsante foto extra visibile e funzionante (upload + EF call)
  - In finished: vista completamente read-only
  </verify>
  <done>MyDishTab mostra il piatto del partecipante in read-only. Ospiti vedono empty state. In voting, foto extra uploadabili. In finished, tutto read-only.</done>
</task>

</tasks>

<verification>
1. `npm run build` compila senza errori
2. GalleryTab mostra griglia 3 colonne con thumbnails piatti
3. Tap su piatto in galleria apre DishDetailSheet con tutti i dettagli
4. DishDetailSheet mostra "Cuoco misterioso" in voting, nome reale in finished
5. MyDishTab mostra piatto del partecipante o empty state per ospite
6. Foto extra uploadabili in voting da MyDishTab
</verification>

<success_criteria>
- DishDetailSheet component riusabile con sezioni espandibili e chef identity protection
- GalleryTab griglia 3 colonne con tap-to-detail
- MyDishTab con vista piatto, empty state ospite, foto extra in voting
- Build TypeScript passa senza errori
</success_criteria>

<output>
After completion, create `.planning/phases/03-voting-voter-screen-sharing/03-02-SUMMARY.md`
</output>
