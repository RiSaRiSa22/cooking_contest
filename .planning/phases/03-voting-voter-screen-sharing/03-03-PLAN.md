---
phase: 03-voting-voter-screen-sharing
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/screens/Voter/tabs/RankingTab.tsx
  - src/screens/Admin/tabs/RankingTab.tsx
  - src/screens/Admin/tabs/SettingsTab.tsx
  - src/hooks/useCompetition.ts
autonomous: true

must_haves:
  truths:
    - "Tab Classifica voter mostra piatti ordinati per voti con medaglie top 3, percentuali e barra progresso"
    - "In fase finished, la classifica voter rivela i nomi dei cuochi (automaticamente dalla view)"
    - "Admin RankingTab aggiornata da sort alfabetico a sort per voteCount con percentuali reali"
    - "Admin ha toggle 'Rivela cuochi' che funziona con i voti reali"
    - "SettingsTab mostra contatore voti reale e link condivisione con QR adattivo (join/vote per fase)"
    - "Link ?code=X&mode=vote funziona (gestito in 03-01)"
  artifacts:
    - path: "src/screens/Voter/tabs/RankingTab.tsx"
      provides: "Classifica voter con voteCount, medaglie, percentuali, barre progresso, chef reveal in finished"
    - path: "src/screens/Admin/tabs/RankingTab.tsx"
      provides: "Classifica admin aggiornata con voteCount reali (non piu sort alfabetico)"
    - path: "src/screens/Admin/tabs/SettingsTab.tsx"
      provides: "Contatore voti reale + link condivisione adattivo (join/vote) + QR code adattivo"
    - path: "src/hooks/useCompetition.ts"
      provides: "Hook admin aggiornato per caricare anche vote counts"
  key_links:
    - from: "src/screens/Voter/tabs/RankingTab.tsx"
      to: "src/store/voterStore.ts"
      via: "useVoterStore per voteCounts e dishes"
      pattern: "useVoterStore"
    - from: "src/screens/Admin/tabs/RankingTab.tsx"
      to: "src/store/competitionStore.ts"
      via: "useCompetitionStore per voteCounts"
      pattern: "useCompetitionStore.*voteCounts"
    - from: "src/hooks/useCompetition.ts"
      to: "supabase/functions/vote-read"
      via: "supabase.functions.invoke('vote-read') per vote counts admin"
      pattern: "vote-read"
---

<objective>
Implementare la classifica con voti reali (voter e admin), aggiornare i placeholder della fase 2 con dati reali, e completare la condivisione con link adattivi e QR code.

Purpose: La classifica e il momento della rivelazione sono il climax dell'esperienza â€” senza voti reali e rivelazione, il core value non e completo. I link condivisione e QR rendono l'onboarding dei partecipanti immediato.

Output: RankingTab voter con voti reali e rivelazione, RankingTab admin aggiornata, SettingsTab con voti e link adattivi, useCompetition con vote counts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-voting-voter-screen-sharing/03-RESEARCH.md
@.planning/phases/03-voting-voter-screen-sharing/03-01-SUMMARY.md

# Key existing files
@src/screens/Admin/tabs/RankingTab.tsx              # DA AGGIORNARE â€” sort alfabetico â†’ sort per voti
@src/screens/Admin/tabs/SettingsTab.tsx              # DA AGGIORNARE â€” contatore voti + link condivisione
@src/store/voterStore.ts                             # Creato in 03-01 â€” voteCounts Map
@src/store/competitionStore.ts                       # DA ESTENDERE â€” aggiungere voteCounts
@src/hooks/useCompetition.ts                         # DA ESTENDERE â€” caricare vote counts
@supabase/functions/vote-read/index.ts               # Creato in 03-01 â€” restituisce voteCounts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RankingTab voter + Admin RankingTab aggiornata + useCompetition con vote counts</name>
  <files>src/screens/Voter/tabs/RankingTab.tsx, src/screens/Admin/tabs/RankingTab.tsx, src/hooks/useCompetition.ts, src/store/competitionStore.ts</files>
  <action>
  **competitionStore.ts â€” aggiungere voteCounts:**
  Aggiungere al tipo `CompetitionStore`:
  ```typescript
  voteCounts: Map<string, number>  // dish_id â†’ count
  setVoteCounts: (counts: Map<string, number>) => void
  ```
  Aggiungere al `initialState`: `voteCounts: new Map()`
  Aggiungere setter: `setVoteCounts: (voteCounts) => set({ voteCounts })`
  Aggiungere al `reset()`: `voteCounts: new Map()`

  **useCompetition.ts â€” caricare vote counts per admin:**
  Dopo il Promise.all esistente (comp + dishes + participants), aggiungere una chiamata a `vote-read` EF per ottenere i vote counts. L'admin non ha un proprio participantId per la lettura dei voti individuali, ma ha bisogno solo dei counts aggregati. Soluzione: usare il participantId dell'admin (dalla sessione) â€” `vote-read` restituisce `voteCounts` per tutta la competizione indipendentemente dal participant. Se participantId non e disponibile (session.participantId e null per admin creato con competition-create), usare un approccio alternativo:
  - Modificare la chiamata in useCompetition per passare il participantId dalla sessione. Se e null, skippare la chiamata vote-read (l'admin senza participantId vedra 0 voti â€” ma in realta il competition-create crea sempre un participant con role=admin, quindi participantId non dovrebbe mai essere null).
  - Fare la chiamata `vote-read` EF e settare `competitionStore.voteCounts`

  **Voter/tabs/RankingTab.tsx â€” classifica voter (VOTR-03, VOTE-04):**
  - Leggere `dishes` e `voteCounts` dal voterStore
  - **Visibile SOLO in phase === 'finished'** (il tab e gia nascosto dal VoterScreen, ma aggiungere anche un guard interno per sicurezza)
  - Calcolare il totale voti: `totalVotes = sum of all voteCounts values`
  - Per ogni piatto: `count = voteCounts.get(dish.id) ?? 0`, `percentage = totalVotes > 0 ? (count / totalVotes * 100) : 0`
  - Ordinare per count DESC, parita per nome ASC
  - Per ogni piatto nella lista:
    - Medaglia (ðŸ¥‡ ðŸ¥ˆ ðŸ¥‰) per top 3, numero posizione per gli altri
    - Nome piatto (font-body semibold)
    - Nome cuoco (`dish.chef_name` â€” in finished, la view lo rivela automaticamente). NON serve toggle nel voter.
    - Conteggio voti e percentuale: "N voti (XX%)"
    - Barra progresso: div con width proporzionale alla percentuale, sfondo ember per il riempimento
  - Empty state se nessun piatto

  **Admin/tabs/RankingTab.tsx â€” aggiornare da sort alfabetico a sort per voti:**
  - Leggere `voteCounts` dal competitionStore (aggiunto sopra)
  - Rimuovere il commento "Sort alphabetically by name (vote-based ranking deferred to Phase 3)"
  - Sort: per count DESC (da voteCounts), parita per nome ASC
  - Aggiornare la UI per ogni piatto:
    - Mantenere la struttura card esistente (medaglie, dish info)
    - Sostituire "â€” voti" con il conteggio reale: `{count} vot{count === 1 ? 'o' : 'i'}`
    - Aggiungere percentuale tra parentesi: `({percentage.toFixed(0)}%)`
    - Aggiungere barra progresso sotto il nome del piatto (stessa delle voter)
  - Rimuovere la nota "Classifica provvisoria Â· conteggio voti disponibile nella Fase 3"
  - Toggle "Rivela cuochi" funziona come prima ma ora con i voti reali
  </action>
  <verify>
  - `npm run build` compila senza errori
  - Admin RankingTab mostra piatti ordinati per voti (non piu alfabetico) con percentuali e barre
  - Voter RankingTab mostra classifica con medaglie, voti, percentuali e nomi cuochi rivelati
  - useCompetition carica vote counts dal vote-read EF
  </verify>
  <done>Classifiche voter e admin mostrano piatti ordinati per voti reali con medaglie, percentuali e barre progresso. Admin ha toggle reveal funzionante. Voter vede nomi cuochi automaticamente in finished.</done>
</task>

<task type="auto">
  <name>Task 2: SettingsTab â€” contatore voti reale + link condivisione adattivo + QR code adattivo</name>
  <files>src/screens/Admin/tabs/SettingsTab.tsx</files>
  <action>
  Aggiornare SettingsTab per:

  **1. Contatore voti reale (sezione Statistiche):**
  - Sostituire il placeholder "â€”" nel contatore voti con il conteggio reale
  - Leggere `voteCounts` dal competitionStore
  - Calcolare totale voti: `totalVotes = Array.from(voteCounts.values()).reduce((sum, c) => sum + c, 0)`
  - Mostrare `totalVotes` al posto di "â€”"

  **2. Link condivisione adattivo (SHAR-01):**
  - `joinUrl` gia esistente: `...#/?code=${code}&mode=join`
  - Aggiungere `voteUrl`: `...#/?code=${code}&mode=vote`
  - Il link condiviso cambia in base alla fase:
    - preparation: `joinUrl` (il QR invita a unirsi)
    - voting: `voteUrl` (il QR invita a votare)
    - finished: `joinUrl` (torna a join per condivisione generica)
  - `shareUrl = phase === 'voting' ? voteUrl : joinUrl`
  - Aggiornare `copyLink` per copiare `shareUrl` (non sempre `joinUrl`)
  - Aggiornare il testo del pulsante: "ðŸ”— Condividi link join" in preparation, "ðŸ”— Condividi link votazione" in voting

  **3. QR code adattivo (SHAR-02):**
  - `qrUrl` gia esiste con `joinUrl` â€” cambiare per usare `shareUrl`
  - Il QR code cambia automaticamente in base alla fase

  **4. Aggiungere sezione link esplicita:**
  Sotto il QR code, mostrare il link testuale `shareUrl` troncato con stile `font-body text-xs break-all` per debug/verifica.
  </action>
  <verify>
  - `npm run build` compila senza errori
  - Contatore voti mostra numero reale (non "â€”")
  - In preparation: link e QR puntano a mode=join
  - In voting: link e QR puntano a mode=vote
  - Pulsante "Condividi link" copia il link corretto
  </verify>
  <done>SettingsTab mostra voti reali, link condivisione adattivo per fase, QR code che cambia automaticamente tra join e vote.</done>
</task>

</tasks>

<verification>
1. `npm run build` compila senza errori
2. Voter RankingTab mostra classifica con voti reali, medaglie, percentuali, barre, nomi cuochi in finished
3. Admin RankingTab aggiornata con voti reali (non piu sort alfabetico)
4. SettingsTab mostra contatore voti reale
5. Link e QR adattivi: join in preparation, vote in voting
6. Toggle "Rivela cuochi" admin funziona con voti reali
</verification>

<success_criteria>
- Classifiche voter e admin usano vote counts reali dal vote-read EF
- Medaglie top 3, percentuali e barre progresso visibili
- Contatore voti reale in SettingsTab
- Link condivisione e QR code adattivi per fase
- Build TypeScript passa senza errori
</success_criteria>

<output>
After completion, create `.planning/phases/03-voting-voter-screen-sharing/03-03-SUMMARY.md`
</output>
